# 文件系统存储功能指南

## 🎯 概述

本应用现在支持**本地文件系统存储**，类似 Obsidian 和 Logseq 的工作方式：

- ✅ 所有笔记以 Markdown 文件形式存储在你选择的文件夹中
- ✅ 使用任何文本编辑器都可以查看和编辑笔记
- ✅ 数据完全由你掌控，可以备份、同步到云端
- ✅ 兼容 Obsidian、Logseq 等其他笔记应用
- ✅ 实时双向同步：应用编辑 ↔ 文件变更

## 🚀 快速开始

### 1. 浏览器要求

需要使用支持 File System Access API 的浏览器：
- ✅ Chrome 86+
- ✅ Edge 86+
- ✅ Opera 72+
- ⚠️ Safari 15.2+（部分支持）
- ❌ Firefox（暂不支持）

### 2. 首次使用

1. 打开应用 http://localhost:5173
2. 应用会显示 "选择笔记文件夹" 界面
3. 点击 "选择笔记文件夹" 按钮
4. 选择一个空文件夹（或创建新文件夹）
5. 授予读写权限
6. 应用会自动创建以下结构：

```
your-notes/
├── .notesdb/         # 元数据（自动生成）
│   └── config.json
├── pages/            # 普通笔记
│   └── (你的笔记.md)
└── journals/         # 日记
    └── (YYYY-MM-DD.md)
```

### 3. 使用现有笔记

如果你已经有 Markdown 笔记文件夹：

1. 选择你的笔记文件夹
2. 应用会自动扫描并导入所有 `.md` 文件
3. 支持的格式：
   - 标准 Markdown
   - 带 YAML frontmatter 的文件
   - Obsidian/Logseq 格式（部分兼容）

## 📁 文件格式

### Markdown 文件结构

每个笔记页面对应一个 `.md` 文件：

```markdown
---
id: "uuid-here"
title: "我的笔记"
type: "note"
created: "2025-01-20T10:00:00.000Z"
updated: "2025-01-20T15:30:00.000Z"
---

- 这是第一个块 ^block-id-1
  - 这是子块 ^block-id-2
  - 另一个子块 ^block-id-3
- 第二个顶层块 ^block-id-4
- 链接到 [[其他页面]] ^block-id-5
```

### 文件名规则

- **普通笔记**: `pages/笔记标题.md`
- **日记**: `journals/2025-01-20.md`
- 特殊字符会自动转换（如空格→连字符）

### 块 ID 标记

- 格式：`^block-id`
- 用于块级引用和同步
- 自动生成，通常不需要手动编辑

## 🔄 同步机制

### 自动同步

- **编辑时同步**: 每次编辑块内容后，自动保存到文件系统
- **文件监听**: 每 5 秒检查文件变更，自动更新到应用
- **后台运行**: 同步在后台进行，不影响编辑体验

### 手动同步

在侧边栏底部点击 "同步" 按钮可手动触发完整同步。

### 同步状态

侧边栏底部显示同步状态：
- 🔵 **同步中**: 正在同步数据
- ✅ **已同步**: 同步成功
- ❌ **同步错误**: 同步失败（查看控制台了解详情）

## ⚙️ 高级功能

### 开发者控制台命令

打开浏览器控制台（F12），使用以下命令：

```javascript
// 查看数据库统计
devTools.stats()

// 手动迁移数据到文件系统
devTools.migrateToFiles()

// 从文件系统导入数据（会覆盖现有数据）
devTools.importFromFiles()

// 导出 JSON 备份
devTools.export()

// 清理重复页面和空块
devTools.cleanup()
```

### 切换笔记库

1. 点击侧边栏底部的设置图标（⚙️）
2. 选择 "切换笔记库"
3. 选择新的文件夹

### 数据迁移

**从 IndexedDB 迁移到文件系统**：
```javascript
// 在控制台执行
devTools.migrateToFiles()
```

**从文件系统导入**：
```javascript
// 在控制台执行
devTools.importFromFiles()
```

## 🛡️ 数据安全

### 权限管理

- 应用只能访问你明确选择的文件夹
- 权限在浏览器会话之间保持
- 可以随时在浏览器设置中撤销权限

### 备份建议

1. **自动备份**: 使用云同步（iCloud Drive、Dropbox、OneDrive）
2. **手动备份**: 定期复制整个笔记文件夹
3. **Git 版本控制**: 使用 Git 跟踪笔记变更（推荐）

### 冲突处理

如果同时在应用和外部编辑器中修改文件：
- 默认策略：文件优先（外部编辑覆盖应用内编辑）
- 应用会在控制台显示冲突警告
- 建议：同一时间只在一个地方编辑

## 🔧 故障排除

### 权限丢失

如果提示权限错误：
1. 刷新页面
2. 重新选择文件夹
3. 授予读写权限

### 同步失败

如果同步失败：
1. 检查文件夹权限
2. 确保文件夹未被其他程序锁定
3. 查看控制台错误信息
4. 尝试手动同步

### 数据恢复

如果数据丢失：
1. 检查文件夹中的 `.md` 文件
2. 使用 `devTools.importFromFiles()` 重新导入
3. 如果有备份，恢复备份文件夹

## 📝 最佳实践

### 文件组织

```
my-notes/
├── pages/
│   ├── 项目/
│   │   ├── 项目A.md
│   │   └── 项目B.md
│   ├── 学习/
│   │   ├── React.md
│   │   └── TypeScript.md
│   └── 想法.md
└── journals/
    ├── 2025-01-20.md
    └── 2025-01-21.md
```

（注意：当前版本暂不支持子文件夹，所有文件在同一层级）

### 外部编辑

使用外部编辑器时：
- 保持 Markdown 格式
- 不要删除 frontmatter
- 不要修改块 ID（`^block-id`）
- 编辑后，应用会在 5 秒内自动同步

### Git 集成

推荐使用 Git 管理笔记：

```bash
cd your-notes
git init
git add .
git commit -m "Initial commit"

# 设置 .gitignore
echo ".notesdb/" > .gitignore
```

## 🆚 与其他应用的兼容性

### Obsidian

- ✅ 基本 Markdown 兼容
- ✅ 双向链接 `[[页面]]` 完全兼容
- ⚠️ 块引用格式不同（Obsidian 使用 `^block-ref`）
- ⚠️ frontmatter 可能有额外字段

### Logseq

- ✅ 页面/日记文件夹结构兼容
- ✅ 列表格式兼容
- ⚠️ 缩进处理略有不同
- ⚠️ 块属性语法不同

## 🔮 未来计划

- [ ] 子文件夹支持
- [ ] 附件管理（图片、PDF）
- [ ] Git 自动提交
- [ ] 冲突合并界面
- [ ] 多设备实时同步
- [ ] 移动端支持

## ❓ 常见问题

**Q: 我的数据存储在哪里？**  
A: 存储在你选择的本地文件夹中，以 Markdown 文件形式。

**Q: 可以不使用文件系统模式吗？**  
A: 可以。如果浏览器不支持或你不选择文件夹，应用会使用 IndexedDB 存储。

**Q: 数据会上传到服务器吗？**  
A: 不会。所有数据完全本地存储，只有 AI 功能会发送内容到 OpenAI API。

**Q: 可以在多个设备上使用吗？**  
A: 可以。将笔记文件夹放在云同步文件夹（iCloud/Dropbox）中即可。

**Q: 如何备份数据？**  
A: 直接复制整个笔记文件夹，或使用 Git 版本控制。

---

**Made with ❤️ for local-first note-taking**

